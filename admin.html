<html lang="en">
onSnapshot(evtQ, snapshot=>{
const wrap = document.getElementById('manageEvents'); wrap.innerHTML=''
snapshot.forEach(snap=>{
const d=snap.data(); const id=snap.id
const date = d.date ? new Date(d.date).toLocaleDateString() : ''
const row = document.createElement('div'); row.className='list-item'
row.innerHTML = `<div><strong>${escapeHtml(d.title||'')}</strong><div class=\"muted\">${date} ${d.location?'- '+escapeHtml(d.location):''}</div></div><div class=\"actions\"><button class=\"btn\" onclick=\"editEvent('${id}')\">Edit</button><button class=\"btn\" style=\"background:#c0392b\" onclick=\"deleteEvent('${id}')\">Delete</button></div>`
wrap.appendChild(row)
})
})


// Notices
const noteQ = query(collection(db,'notices'), orderBy('createdAt','desc'))
onSnapshot(noteQ,snapshot=>{
const wrap=document.getElementById('manageNotices'); wrap.innerHTML=''
snapshot.forEach(snap=>{
const d=snap.data(); const id=snap.id
const row=document.createElement('div'); row.className='list-item'
row.innerHTML = `<div><strong>${escapeHtml(d.title||'')}</strong><div class=\"muted\">${d.createdAt?new Date(d.createdAt.toMillis()).toLocaleString():''}</div></div><div class=\"actions\"><button class=\"btn\" onclick=\"editNotice('${id}')\">Edit</button><button class=\"btn\" style=\"background:#c0392b\" onclick=\"deleteNotice('${id}')\">Delete</button></div>`
wrap.appendChild(row)
})
})
}


// Edit/Delete functions - using global functions so the inline onclick attributes can call them
window.deleteUpdate = async(id)=>{ if(!confirm('Delete update?')) return; await deleteDoc(doc(db,'updates',id)) }
window.deleteGallery = async(id)=>{ if(!confirm('Delete image?')) return; await deleteDoc(doc(db,'gallery',id)) }
window.deleteEvent = async(id)=>{ if(!confirm('Delete event?')) return; await deleteDoc(doc(db,'events',id)) }
window.deleteNotice = async(id)=>{ if(!confirm('Delete notice?')) return; await deleteDoc(doc(db,'notices',id)) }


window.editUpdate = async(id)=>{
const newTitle = prompt('New title')
const newBody = prompt('New body')
if(newTitle==null && newBody==null) return
const payload = {}
if(newTitle!=null) payload.title=newTitle
if(newBody!=null) payload.body=newBody
await updateDoc(doc(db,'updates',id), payload)
}


window.editGallery = async(id, url, cap)=>{
const newUrl = prompt('Image URL', url)
const newCap = prompt('Caption', cap)
if(newUrl==null && newCap==null) return
const payload={}
if(newUrl!=null) payload.url=newUrl
if(newCap!=null) payload.caption=newCap
await updateDoc(doc(db,'gallery',id), payload)
}


window.editEvent = async(id)=>{
const newTitle = prompt('Title')
const newDate = prompt('Date (YYYY-MM-DD)')
const newLoc = prompt('Location')
const newDesc = prompt('Description')
const payload={}
if(newTitle!=null) payload.title=newTitle
if(newDate) payload.date = new Date(newDate).toISOString()
if(newLoc!=null) payload.location=newLoc
if(newDesc!=null) payload.description=newDesc
await updateDoc(doc(db,'events',id), payload)
}


window.editNotice = async(id)=>{
const newTitle = prompt('Title')
const newBody = prompt('Body')
const payload={}
if(newTitle!=null) payload.title=newTitle
if(newBody!=null) payload.body=newBody
await updateDoc(doc(db,'notices',id), payload)
}


// Helpers
function escapeHtml(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }
function escapeJS(s){ if(!s) return ''; return String(s).replaceAll("'","\\'").replaceAll('\\','\\\\') }


</script>
</body>
</html>
