<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Crescent Admin</title>
<link rel="icon" href="../assets/logo.jpg">
<style>
  :root{
    --green:#0b7d2b; --greenDark:#0a5a22; --gold:#d4af37;
    --bg:#f3f6f4; --card:#ffffff; --ink:#0f172a; --muted:#94a3b8;
    --radius:18px; --shadow:0 10px 30px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box} html,body{margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}
  .center{min-height:100dvh;display:grid;place-items:center;padding:16px}
  .login{max-width:380px;width:100%;padding:22px;border-radius:22px;background:#fff;box-shadow:var(--shadow);border:1px solid #e8eee9;text-align:center}
  input{width:100%;padding:12px;border:1px solid #e5efe6;border-radius:12px}
  button{background:var(--green);color:#fff;border:none;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
  .appbar{position:sticky;top:0;background:linear-gradient(140deg,var(--greenDark),var(--green));color:#fff;padding:14px 16px;display:flex;gap:12px;align-items:center;z-index:10}
  .wrap{max-width:980px;margin:0 auto;padding:16px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:#fff;border-radius:18px;box-shadow:var(--shadow);padding:16px}
  label{display:block;font-weight:700;margin-top:8px}
  .list{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .item{background:#f7faf7;border:1px solid #e5efe6;border-radius:14px;padding:10px}
  .danger{background:#a31212}
</style>
</head>
<body>

<!-- Admin MPIN -->
<div id="lock" class="center">
  <div class="login">
    <img src="../assets/logo.jpg" alt="logo" style="width:72px;height:72px;border-radius:999px;border:2px solid var(--gold);margin-bottom:8px">
    <h2 style="margin:0">Crescent Admin</h2>
    <p style="margin:.25rem 0 1rem 0;color:#64748b">Enter Admin MPIN</p>
    <input id="adminPin" type="password" inputmode="numeric" maxlength="6" placeholder="123456">
    <div style="margin-top:10px;display:flex;gap:8px;justify-content:center">
      <button id="unlock">Enter</button>
    </div>
  </div>
</div>

<!-- Admin App -->
<div id="app" style="display:none">
  <div class="appbar">
    <strong>Admin ‚Ä¢ Crescent School</strong>
    <div style="margin-left:auto;display:flex;gap:8px">
      <button id="logout" class="danger">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <!-- Updates -->
      <div class="card">
        <h3>üîî Add Update</h3>
        <label>Update Text</label>
        <input id="updText" placeholder="e.g., School reopens on 30 Sept.">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="addUpdate">Add Update</button>
          <button id="clearUpdates" class="danger">Clear All</button>
        </div>
        <div class="list" id="updatesList"></div>
      </div>

      <!-- Calendar -->
      <div class="card">
        <h3>üìÖ Add Calendar Event</h3>
        <label>Date</label>
        <input id="evDate" type="date">
        <label>Title</label>
        <input id="evTitle" placeholder="e.g., Parent Orientation">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="addEvent">Add Event</button>
          <button id="clearEvents" class="danger">Clear All</button>
        </div>
        <div class="list" id="eventsList"></div>
      </div>

      <!-- Gallery -->
      <div class="card">
        <h3>üñºÔ∏è Add Gallery Photo</h3>
        <label>Image URL</label>
        <input id="photoUrl" placeholder="https://...">
        <div style="margin-top:10px;display:flex;gap:8px">
          <button id="addPhoto">Add Photo</button>
          <button id="clearPhotos" class="danger">Clear All</button>
        </div>
        <div class="list" id="photosList"></div>
      </div>

      <!-- Tools -->
      <div class="card">
        <h3>‚öôÔ∏è Tools</h3>
        <button id="openApp" onclick="window.open('../index.html','_blank')">Open User App</button>
        <p style="color:#64748b;margin-top:10px">All data is stored on this device using localStorage.</p>
      </div>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<script>
  // Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBBIG7IpuY8Hc3E0_zcEyon06an8ll6TGw",
    authDomain: "school-test-4b350.firebaseapp.com",
    projectId: "school-test-4b350",
    storageBucket: "school-test-4b350.firebasestorage.app",
    messagingSenderId: "557567714700",
    appId: "1:557567714700:web:be0df02162246ee5d5a2a9"
  };

  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const DEFAULT_PIN = '123456'; // Admin MPIN

  // Auth
  document.getElementById('unlock').onclick = ()=>{
    if(document.getElementById('adminPin').value === DEFAULT_PIN){
      document.getElementById('lock').style.display='none';
      document.getElementById('app').style.display='block';
      renderAll();
    } else alert('Wrong MPIN');
  };
  document.getElementById('logout').onclick = ()=> location.reload();

  // Updates
  const updInput = document.getElementById('updText');
  document.getElementById('addUpdate').onclick = async ()=>{
    const text = (updInput.value||'').trim();
    if(!text) return alert('Enter update text');
    try {
      await db.collection('updates').add({
        text: text,
        time: firebase.firestore.FieldValue.serverTimestamp() // Use server timestamp
      });
      updInput.value='';
      renderUpdates(); // Re-render to show new update
    } catch (e) {
      console.error("Error adding document: ", e);
      alert('Failed to add update.');
    }
  };
  document.getElementById('clearUpdates').onclick = async ()=>{
    if(confirm('Clear ALL updates?')){
      try {
        const snapshot = await db.collection('updates').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        renderUpdates(); // Re-render after clearing
      } catch (e) {
        console.error("Error clearing updates: ", e);
        alert('Failed to clear updates.');
      }
    }
  };

  // Events
  const evDate = document.getElementById('evDate');
  const evTitle = document.getElementById('evTitle');
  document.getElementById('addEvent').onclick = async ()=>{
    if(!evDate.value || !evTitle.value.trim()) return alert('Enter date and title');
    try {
      await db.collection('events').add({
        date: evDate.value,
        title: evTitle.value.trim()
      });
      evDate.value=''; evTitle.value='';
      renderEvents(); // Re-render to show new event
    } catch (e) {
      console.error("Error adding event: ", e);
      alert('Failed to add event.');
    }
  };
  document.getElementById('clearEvents').onclick = async ()=>{
    if(confirm('Clear ALL events?')){
      try {
        const snapshot = await db.collection('events').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        renderEvents(); // Re-render after clearing
      } catch (e) {
        console.error("Error clearing events: ", e);
        alert('Failed to clear events.');
      }
    }
  };

  // Photos
  const photoUrl = document.getElementById('photoUrl');
  document.getElementById('addPhoto').onclick = async ()=>{
    const url = (photoUrl.value||'').trim();
    if(!/^https?:\/\//i.test(url)) return alert('Enter a valid image URL (http/https)');
    try {
      await db.collection('photos').add({
        url: url
      });
      photoUrl.value='';
      renderPhotos(); // Re-render to show new photo
    } catch (e) {
      console.error("Error adding photo: ", e);
      alert('Failed to add photo.');
    }
  };
  document.getElementById('clearPhotos').onclick = async ()=>{
    if(confirm('Clear ALL photos?')){
      try {
        const snapshot = await db.collection('photos').get();
        const batch = db.batch();
        snapshot.docs.forEach(doc => {
          batch.delete(doc.ref);
        });
        await batch.commit();
        renderPhotos(); // Re-render after clearing
      } catch (e) {
        console.error("Error clearing photos: ", e);
        alert('Failed to clear photos.');
      }
    }
  };

  // Renderers (fetching data from Firestore)
  function renderUpdates(){
    const list = document.getElementById('updatesList');
    list.innerHTML = '';
    db.collection('updates').orderBy('time', 'desc').onSnapshot(snapshot => {
      list.innerHTML = ''; // Clear list before re-rendering
      snapshot.docs.forEach(doc => {
        const u = doc.data();
        const d = new Date(u.time ? u.time.toDate() : Date.now());
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = `<b>${d.toLocaleString()}</b><div>${u.text}</div>`;
        list.appendChild(el);
      });
    }, error => {
      console.error("Error getting updates: ", error);
      list.innerHTML = '<div class="item" style="color:red;">Error loading updates.</div>';
    });
  }
  function renderEvents(){
    const list = document.getElementById('eventsList');
    list.innerHTML = '';
    db.collection('events').orderBy('date').onSnapshot(snapshot => {
      list.innerHTML = ''; // Clear list before re-rendering
      snapshot.docs.forEach(doc => {
        const ev = doc.data();
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = `<b>${ev.date}</b> ‚Äî ${ev.title}`;
        list.appendChild(el);
      });
    }, error => {
      console.error("Error getting events: ", error);
      list.innerHTML = '<div class="item" style="color:red;">Error loading events.</div>';
    });
  }
  function renderPhotos(){
    const list = document.getElementById('photosList');
    list.innerHTML = '';
    db.collection('photos').onSnapshot(snapshot => {
      list.innerHTML = ''; // Clear list before re-rendering
      snapshot.docs.forEach(doc => {
        const url = doc.data().url;
        const el = document.createElement('div'); el.className='item';
        el.innerHTML = `<a href="${url}" target="_blank">${url}</a>`;
        list.appendChild(el);
      });
    }, error => {
      console.error("Error getting photos: ", error);
      list.innerHTML = '<div class="item" style="color:red;">Error loading photos.</div>';
    });
  }
  function renderAll(){ renderUpdates(); renderEvents(); renderPhotos(); }
</script>
</body>
</html>
