<html lang="en">
list.innerHTML = ''
snap.forEach(doc=>{
const d = doc.data()
const el = document.createElement('div'); el.className='update'
el.innerHTML = `<h3>${escapeHTML(d.title||'Untitled')}</h3><div class="meta">${new Date(d.createdAt?.toDate ? d.createdAt.toDate() : d.createdAt).toLocaleString()}</div><p>${escapeHTML(d.body||'')}</p>`
list.appendChild(el)
})
}catch(e){ list.innerHTML = '<div class="meta">Could not load updates.</div>' ; console.error(e) }
}


// Load events from collection 'events'
async function loadEvents(){
const list = document.getElementById('eventsList')
list.innerHTML='Loading events...'
try{
const q = query(collection(db,'events'), orderBy('date','asc'))
const snap = await getDocs(q)
if(snap.empty){ list.innerHTML='<div class="meta">No events yet</div>'; return }
list.innerHTML=''
snap.forEach(doc=>{
const d = doc.data()
const dateStr = d.date?.toDate ? new Date(d.date.toDate()).toDateString() : (d.date? new Date(d.date).toDateString() : 'Unknown')
const el = document.createElement('div'); el.className='event'
el.innerHTML = `<strong>${escapeHTML(d.title||'Event')}</strong> <div class="meta">${dateStr} â€¢ ${escapeHTML(d.type||'General')}</div><p>${escapeHTML(d.note||'')}</p>`
list.appendChild(el)
})
}catch(e){ list.innerHTML='<div class="meta">Could not load events.</div>'; console.error(e) }
}


// Load gallery from Storage folder 'gallery' (or from 'gallery' collection urls if maintenance required)
async function loadGallery(){
const grid = document.getElementById('galleryGrid')
grid.innerHTML='Loading gallery...'
try{
const listRef = ref(storage,'gallery')
const res = await listAll(listRef)
grid.innerHTML=''
if(res.items.length===0){ grid.innerHTML='<div class="meta">No photos yet</div>'; return }
const urls = await Promise.all(res.items.map(i=>getDownloadURL(i)))
urls.forEach(u => {
const img = document.createElement('img'); img.src = u
grid.appendChild(img)
})
}catch(e){
grid.innerHTML='<div class="meta">Could not load gallery.</div>'
console.error(e)
}
}


// Helper escape
function escapeHTML(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])) }


// initApp after MPIN
function initApp(){ loadUpdates(); loadEvents(); loadGallery();
// optional: poll every 20s to keep fresh (simple)
setInterval(()=>{ loadUpdates(); loadEvents(); loadGallery() }, 20000)
}


</script>
</body>
</html>
